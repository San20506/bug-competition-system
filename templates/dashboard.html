
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bug Bounty</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script>
        setInterval(() => { 
            document.getElementById('live-frame').src = "/leaderboard?ts=" + new Date().getTime(); 
        }, 10000);
    </script>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="dashboard-content">
                <h1 class="dashboard-title">ğŸ“‹ Admin Dashboard</h1>
            </div>
        </div>

        <div class="dashboard-content">
            {% if msg %}
                <div class="success-message">
                    âœ… {{ msg }}
                </div>
            {% endif %}

            <!-- TIMER SECTION -->
            <div class="admin-section">
                <h3 class="section-title">â± Timer Control</h3>
                <form method="POST">
                    <div class="form-row">
                        <input type="number" name="duration" placeholder="Minutes" value="{{ timer['duration'] }}" class="form-control-modern" style="background: white; color: #2d3748;">
                        <button name="action" value="start_timer" class="btn-modern btn-success">â–¶ Start</button>
                        <button name="action" value="stop_timer" class="btn-modern btn-danger">â¹ Stop</button>
                        <button name="action" value="reset_timer" class="btn-modern btn-warning">ğŸ”„ Reset</button>
                    </div>
                </form>
                <div class="status-badge">
                    ğŸ•“ Status: {{ timer['status'] }} | Started: {{ timer['start_time'] }}
                </div>
            </div>

            <!-- SCORES SECTION -->
            <div class="admin-section">
                <h3 class="section-title">âœ Edit Scores</h3>
                <form method="POST">
                    <input type="hidden" name="action" value="update_scores">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>Score</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in scores %}
                            <tr>
                                <td style="font-weight: 600;">{{ row[1] }}</td>
                                <td><input name="score_{{ row[0] }}" value="{{ row[2] }}"></td>
                                <td><input name="duration_{{ row[0] }}" value="{{ row[3] }}"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="submit" class="btn-modern" style="margin-top: 20px;">ğŸ’¾ Save Changes</button>
                </form>
            </div>

            <!-- TEAM MANAGEMENT -->
            <div class="admin-section">
                <h3 class="section-title">ğŸ‘¥ Manage Teams</h3>

                <!-- Add Team -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h4 style="margin-bottom: 20px; color: #2d3748;">â• Add Single Team</h4>
                    <form method="POST">
                        <div class="form-row">
                            <input type="text" name="teamname" placeholder="Team Name" required class="form-control-modern" style="background: white; color: #2d3748;">
                            <input type="text" name="teampassword" placeholder="Password" required class="form-control-modern" style="background: white; color: #2d3748;">
                            <select name="site_id" required class="form-control-modern" style="background: white; color: #2d3748;">
                                <option value="">Select Site</option>
                                {% for site_id, site_info in sites.items() %}
                                <option value="{{ site_id }}">Site {{ site_id }} - {{ site_info.name }}</option>
                                {% endfor %}
                            </select>
                            <button name="action" value="add_team" class="btn-modern">Add Team</button>
                        </div>
                    </form>
                </div>

                <!-- Change Password -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h4 style="margin-bottom: 20px; color: #2d3748;">ğŸ”‘ Change Team Password</h4>
                    <form method="POST">
                        <div class="form-row">
                            <select name="teamname" required class="form-control-modern" style="background: white; color: #2d3748;">
                                <option value="">Select Team</option>
                                {% for team in teams %}
                                <option value="{{ team[0] }}">{{ team[0] }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="newpassword" placeholder="New Password" required class="form-control-modern" style="background: white; color: #2d3748;">
                            <button name="action" value="change_password" class="btn-modern btn-warning">Change Password</button>
                        </div>
                    </form>
                </div>

                <!-- Change Site Assignment -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h4 style="margin-bottom: 20px; color: #2d3748;">ğŸ¯ Change Team Site Assignment</h4>
                    <form method="POST">
                        <div class="form-row">
                            <select name="teamname" required class="form-control-modern" style="background: white; color: #2d3748;">
                                <option value="">Select Team</option>
                                {% for team in teams %}
                                <option value="{{ team[0] }}">{{ team[0] }} (Site {{ team[2] }})</option>
                                {% endfor %}
                            </select>
                            <select name="site_id" required class="form-control-modern" style="background: white; color: #2d3748;">
                                <option value="">New Site</option>
                                {% for site_id, site_info in sites.items() %}
                                <option value="{{ site_id }}">Site {{ site_id }} - {{ site_info.name }}</option>
                                {% endfor %}
                            </select>
                            <button name="action" value="change_site" class="btn-modern">Change Site</button>
                        </div>
                    </form>
                </div>

                <!-- Delete Team -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h4 style="margin-bottom: 20px; color: #2d3748;">ğŸ—‘ Delete Team</h4>
                    <form method="POST">
                        <div class="form-row">
                            <select name="teamname" required class="form-control-modern" style="background: white; color: #2d3748;">
                                <option value="">Select Team</option>
                                {% for team in teams %}
                                <option value="{{ team[0] }}">{{ team[0] }} (Site {{ team[2] }})</option>
                                {% endfor %}
                            </select>
                            <button name="action" value="delete_team" onclick="return confirm('Delete this team and their scores?')" class="btn-modern btn-danger">Delete Team</button>
                        </div>
                    </form>
                </div>

                <!-- Bulk Import -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h4 style="margin-bottom: 20px; color: #2d3748;">ğŸ“¥ Bulk Import Teams (CSV)</h4>
                    <form method="POST" enctype="multipart/form-data">
                        <div class="form-row">
                            <input type="file" name="file" accept=".csv" required class="form-control-modern" style="background: white; color: #2d3748;">
                            <button name="action" value="bulk_teams" class="btn-modern">Upload CSV</button>
                        </div>
                        <small style="color: #718096;">Format: name,password,site_id (site_id optional, defaults to 1)</small>
                    </form>
                </div>

                <!-- Teams List -->
                <h4 style="margin-bottom: 20px; color: #2d3748;">ğŸ“‹ Registered Teams</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Team Name</th>
                                <th>Password</th>
                                <th>Assigned Site</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in teams %}
                            <tr>
                                <td style="font-weight: 600;">{{ team[0] }}</td>
                                <td style="font-family: monospace;">{{ team[1] }}</td>
                                <td>
                                    <span class="site-badge">Site {{ team[2] }}</span>
                                    <small style="color: #718096; display: block;">{{ sites.get(team[2]|string, {}).get('name', 'Unknown') }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reset DB -->
            <div class="admin-section">
                <h3 class="section-title">ğŸ§¨ Reset Database</h3>
                <div style="background: #fef5e7; border: 2px solid #f6ad55; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <p style="color: #c05621; font-weight: 600; margin-bottom: 10px;">âš ï¸ Warning: This will erase ALL scores and teams!</p>
                    <p style="color: #9c4221; font-size: 0.9rem;">This action cannot be undone. Please confirm before proceeding.</p>
                </div>
                <form method="POST">
                    <button name="action" value="reset_db" onclick="return confirm('Are you sure you want to erase ALL scores and teams?')" class="btn-modern btn-danger">ğŸ’¥ Reset Everything</button>
                </form>
            </div>

            <!-- QR CODE MANAGEMENT -->
            <div class="admin-section">
                <h3 class="section-title">ğŸ› Bug Sites Management</h3>
                <div style="text-align: center;">
                    <a href="/admin/sites" class="btn-modern" style="padding: 20px 40px; font-size: 1.1rem;">ğŸ”§ Manage Bug Sites & QR Codes</a>
                </div>
            </div>

            <!-- LIVE LEADERBOARD -->
            <div class="admin-section">
                <h3 class="section-title">ğŸ“Š Live Leaderboard</h3>
                <div style="border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                    <iframe id="live-frame" src="/leaderboard" width="100%" height="400px" style="border: none; border-radius: 15px;"></iframe>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
